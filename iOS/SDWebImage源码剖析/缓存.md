# 缓存

参考链接：
- [https://stackoverflow.com/questions/824152/what-takes-precedence-the-etag-or-last-modified-http-header/824209#824209](https://stackoverflow.com/questions/824152/what-takes-precedence-the-etag-or-last-modified-http-header/824209#824209)
- [https://www.jianshu.com/p/fb5aaeac06ef](https://www.jianshu.com/p/fb5aaeac06ef)


网络缓存一般指内存缓存和磁盘缓存，iOS提供了NSURLCache用于处理网络缓存。

### NSURLCache
An object that maps URL requests to cached response objects.
The NSURLCache class implements the caching of responses to URL load requests by mapping NSURLRequest objects to NSCachedURLResponse objects. It provides a composite in-memory and on-disk cache, and lets you manipulate the sizes of both the in-memory and on-disk portions. You can also control the path where cache data is stored persistently.

### 控制文件缓存的有效性
服务器的文件存贮，大多采用资源变动后就重新生成一个链接的做法。但不排除存在不同文件使用同一个链接的情况。那么如果服务端的file更改了，本地已经有了缓存。如何更新缓存？
这种情况下需要借助 ETag 或 Last-Modified 判断图片缓存是否有效。
在浏览器第一次请求某一个URL时，服务器端的返回状态会是200，内容是你请求的资源，同时有一个Last-Modified的属性标记此文件在服务期端最后被修改的时间，格式类似这样：
last-modified: Thu, 30 Jun 2011 02:52:19 GMT // Last-Modified 是资源最后修改的时间戳，往往与缓存时间进行对比来判断缓存是否过期
客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送 If-Modified-Since 报头，询问该时间之后文件是否有被修改过：
If-Modified-Since: Thu, 30 Jun 2011 02:52:19 GMT
如果服务器端的资源没有变化，则自动返回 HTTP 304 （Not Changed.）状态码，内容为空，这样就节省了传输数据量。

以请求百度上面一张图片为例：
https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1559197432643&di=d99c5caa027c418d1995d1646e6f2c2e&imgtype=0&src=http%3A%2F%2Fpic15.nipic.com%2F20110628%2F1369025_192645024000_2.jpg

当第一次请求时：
![](./images/1.png)

```
-- General --
Request URL: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1559197432643&di=d99c5caa027c418d1995d1646e6f2c2e&imgtype=0&src=http%3A%2F%2Fpic15.nipic.com%2F20110628%2F1369025_192645024000_2.jpg
Request Method: GET
Status Code: 200 
Remote Address: 183.131.118.48:443
Referrer Policy: no-referrer-when-downgrade

-- Response Headers --
accept-ranges: bytes
age: 8373122
cache-control: max-age=315360000
content-length: 94569
content-type: image/jpeg
date: Thu, 30 May 2019 03:38:43 GMT
etag: "80f315bad036cc1:0"
expires: Mon, 19 Feb 2029 05:46:41 GMT
image-center-request-id: 348a2d58-35a6-4b79-9f2a-f1af05dd6c43
last-modified: Thu, 30 Jun 2011 02:52:19 GMT
ohc-response-time: 1 0 0 0 0 0
server: JSP3/2.0.14
status: 200
x-img-generate-time: 1550814401
x-img-original-height: 641
x-img-original-size: 247176
x-img-original-width: 1024
x-img-thumnail-height: 641
x-img-thumnail-size: 94569
x-img-thumnail-width: 1024

-- Request Headers --
:authority: timgsa.baidu.com
:method: GET
:path: /timg?image&quality=80&size=b9999_10000&sec=1559197432643&di=d99c5caa027c418d1995d1646e6f2c2e&imgtype=0&src=http%3A%2F%2Fpic15.nipic.com%2F20110628%2F1369025_192645024000_2.jpg
:scheme: https
accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
accept-encoding: gzip, deflate, br
accept-language: zh-CN,zh;q=0.9,en;q=0.8
cache-control: max-age=0
cookie: BIDUPSID=8E...
user-agent: Mozilla/5.0 (Linux; ...
```
再次请求时：
![](./images/2.png)

```
-- General --
Request URL: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1559197432643&di=d99c5caa027c418d1995d1646e6f2c2e&imgtype=0&src=http%3A%2F%2Fpic15.nipic.com%2F20110628%2F1369025_192645024000_2.jpg
Request Method: GET
Status Code: 304 
Remote Address: 183.131.118.48:443
Referrer Policy: no-referrer-when-downgrade

-- Response Headers --
accept-ranges: bytes
age: 8373946
cache-control: max-age=315360000
content-length: 0
content-type: image/jpeg
date: Thu, 30 May 2019 03:52:27 GMT
etag: "80f315bad036cc1:0"
expires: Mon, 19 Feb 2029 05:46:41 GMT
image-center-request-id: 348a2d58-35a6-4b79-9f2a-f1af05dd6c43
last-modified: Thu, 30 Jun 2011 02:52:19 GMT
ohc-response-time: 1 0 0 0 0 0
server: JSP3/2.0.14
status: 304
x-img-generate-time: 1550814401
x-img-original-height: 641
x-img-original-size: 247176
x-img-original-width: 1024
x-img-thumnail-height: 641
x-img-thumnail-size: 94569
x-img-thumnail-width: 1024

-- Request Headers --
:authority: timgsa.baidu.com
:method: GET
:path: /timg?image&quality=80&size=b9999_10000&sec=1559197432643&di=d99c5caa027c418d1995d1646e6f2c2e&imgtype=0&src=http%3A%2F%2Fpic15.nipic.com%2F20110628%2F1369025_192645024000_2.jpg
:scheme: https
accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
accept-encoding: gzip, deflate, br
accept-language: zh-CN,zh;q=0.9,en;q=0.8
cache-control: max-age=0
cookie: BIDUPSID=8E4E4EB97A...
if-modified-since: Thu, 30 Jun 2011 02:52:19 GMT
if-none-match: "80f315bad036cc1:0"
upgrade-insecure-requests: 1
user-agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Mobile Safari/537.36
```

伪代码示例：
```Objective-C
if ETagFromServer != ETagOnClient || LastModifiedFromServer != LastModifiedOnClient
  GetFromServer
else
  GetFromCache
```


